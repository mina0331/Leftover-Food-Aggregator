{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 40px auto;">

  <h1 style="text-align:center; color:#232D4B; margin-bottom:20px;">
    Events Map
  </h1>

  <div style="text-align:center; margin-bottom:15px;">
    <a href="{% url 'posting:post_list' %}"
       style="text-decoration:none; color:#232D4B;">
       ← Back to all events
    </a>
  </div>

  <!-- Map container -->
  <div id="map" style="height: 550px; width: 100%; border-radius:12px; overflow:hidden;"></div>

</div>

<style>
    .user-marker {
        padding: 0 !important;
        margin: 0 !important;
    }
    .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        overflow: hidden;
        padding: 0;
        margin: 0;
        line-height: 0;
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

</style>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>


<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

    <script>
        const userPhotoUrl = "{{ request.user.profile.avatar_url}}";
    </script>

<script>
  // posts from Django
  const posts = JSON.parse('{{ posts_json|escapejs }}');

  const userIcon = L.divIcon({
  html: `<div class="user-avatar"><img src="${userPhotoUrl}" /></div>`,
  className: 'user-marker',
  iconSize: [48, 48],
  iconAnchor: [24, 24],
});

  // UVA center
  const UVA_LAT = 38.0336;
  const UVA_LNG = -78.5080;

  // create map
  const map = L.map('map').setView([UVA_LAT, UVA_LNG], 15);

  // base tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // markers for posts
  // Group posts by coordinates
const groups = {};

posts.forEach(p => {
  const key = `${p.lat},${p.lng}`;
  if (!groups[key]) {
    groups[key] = {
      lat: p.lat,
      lng: p.lng,
      building: p.building,
      events: []
    };
  }
  groups[key].events.push(p);
});

// Create one marker per location, with all events in the popup
Object.values(groups).forEach(group => {
  const marker = L.marker([group.lat, group.lng]).addTo(map);

  let popupHtml = `<b>${group.building}</b><br/>`;

  group.events.forEach(ev => {
    popupHtml += `
      <div style="margin-top:6px; padding-top:6px; border-top:1px solid #eee;">
        <strong>${ev.event}</strong><br/>
        <a href="${ev.detail_url}">View details →</a>
      </div>
    `;
  });

  marker.bindPopup(popupHtml);
});


  let userMarker = null;
let firstFix = true;

if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    pos => {
      const userLat = pos.coords.latitude;
      const userLng = pos.coords.longitude;

      if (!userMarker) {
        // First update → create the marker once
        userMarker = L.marker([userLat, userLng], { icon: userIcon })
          .addTo(map)
          .bindPopup("You are here");

        // Center map only the first time
        if (firstFix) {
          map.setView([userLat, userLng], 16);
          firstFix = false;
        }
      } else {
        // Later updates → just move the marker
        userMarker.setLatLng([userLat, userLng]);
      }
    },
    err => {
      console.warn("Geo error:", err);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 10000,
    }
  );
}
</script>
{% endblock %}
